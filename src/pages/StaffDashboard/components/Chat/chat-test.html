<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>Customer Anonymous Chat</title>
  <style>
    body { font-family:sans-serif; margin:16px; }
    #messages { border:1px solid #ccc; height:260px; overflow-y:auto; padding:8px; }
    .me { color:#0a7; }
  </style>
</head>
<body>
<h3>Customer Anonymous Chat</h3>
<div>
  <button id="newChat">Open Chat</button>
  <span id="sid" style="margin-left:8px;color:#555"></span>
</div>

<div id="messages" style="margin-top:10px;"></div>
<div style="margin-top:8px;">
  <input id="text" placeholder="Type a message..." style="width:70%"/>
  <button id="send">Send</button>
  <button id="close">Close Chat</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
  let stomp = null;
  let sessionId = null;
  let sub = null;

  function uuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });
  }

  function logMine(msg) {
    const div = document.createElement('div');
    div.innerHTML = `<span class="me">Me:</span> ${msg}`;
    document.getElementById('messages').appendChild(div);
    const box = document.getElementById('messages');
    box.scrollTop = box.scrollHeight;
  }
  function logOther(msg) {
    const div = document.createElement('div');
    div.textContent = msg;
    document.getElementById('messages').appendChild(div);
    const box = document.getElementById('messages');
    box.scrollTop = box.scrollHeight;
  }

  function connectAndSubscribe() {
    const socket = new SockJS('http://localhost:8080/ws');
    stomp = Stomp.over(socket);
    stomp.debug = () => {};
    stomp.connect({}, () => {
      // CHỈ hiển thị tin từ STAFF; bỏ qua echo của chính customer
      sub = stomp.subscribe(`/topic/chat/${sessionId}`, frame => {
        const m = JSON.parse(frame.body);
        if (m.sender !== 'STAFF') return; // quan trọng: tránh hiển thị "You: ..."
        logOther(`Staff: ${m.content}`);
      });
    }, err => {
      console.error('Connect error', err);
      alert('Cannot connect. Check backend /ws and CORS.');
    });
  }

  document.getElementById('newChat').onclick = () => {
    if (sub) { sub.unsubscribe(); sub = null; }
    if (stomp && stomp.connected) { try { stomp.disconnect(()=>{});} catch{} }
    sessionId = uuid();
    document.getElementById('sid').textContent = `Session: ${sessionId}`;
    document.getElementById('messages').innerHTML = '';
    connectAndSubscribe();
  };

  document.getElementById('send').onclick = () => {
    const input = document.getElementById('text');
    const content = input.value.trim();
    if (!content || !stomp || !stomp.connected || !sessionId) return;

    // Optimistic append: hiển thị ngay tin của mình
    logMine(content);

    stomp.send('/app/chat.send', {}, JSON.stringify({
      sessionId,
      sender: 'CUSTOMER',
      content,
      timestamp: Date.now()
    }));
    input.value = '';
  };

  document.getElementById('close').onclick = () => {
    if (stomp && stomp.connected && sessionId) {
      stomp.send('/app/chat.close', {}, JSON.stringify({ sessionId }));
    }
    if (sub) { sub.unsubscribe(); sub = null; }
    if (stomp) { try { stomp.disconnect(()=>{});} catch{} }
    sessionId = null;
    document.getElementById('sid').textContent = '';
    document.getElementById('messages').innerHTML = '';
  };

  // Khởi tạo 1 chat ngay từ đầu
  document.getElementById('newChat').click();
</script>
</body>
</html>